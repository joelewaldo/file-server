{% extends "files_base.html" %} {% block content %}
<div class="content">
  <h1>Welcome to the File Server</h1>

  <!-- Search Bar -->
  <div class="search-bar-container">
    <div class="search-bar-wrapper">
      <i class="fas fa-search"></i>
      <input
        type="text"
        autocomplete="off"
        id="search-bar"
        placeholder="Search in Server"
        aria-haspopup="true"
      />
      <div id="search-dropdown" class="search-dropdown">
        <div id="search-history" class="search-history">
          <p>No recent searches</p>
          <!-- Add recent searches dynamically here -->
        </div>
        <div id="search-results" class="search-results" style="display: none">
          <!-- Search results will be dynamically added here -->
        </div>
        <button id="advanced-search-btn">Advanced Search</button>
      </div>
    </div>
  </div>

  <div class="toggle-button-container">
    <div class="toggle-button" id="toggleButton">
      {% if folder_data %}
      <a
        class="toggle-option grid-view"
        href="{{ url_for('main.list_files', folder_id=folder_data[-1][1]) }}"
      >
        <div class="">
          <i class="fas fa-list"></i>
          <!-- Grid view icon -->
        </div>
      </a>
      <a
        class="toggle-option file-view"
        href="{{ url_for('main.gallery', folder_id=folder_data[-1][1]) }}"
      >
        <div class="">
          <i class="fas fa-th"></i>
          <!-- File view icon -->
        </div>
      </a>
      {% else %}
      <a
        class="toggle-option grid-view"
        href="{{ url_for('main.list_files') }}"
      >
        <div class="">
          <i class="fas fa-list"></i>
          <!-- Grid view icon -->
        </div>
      </a>
      <a class="toggle-option file-view" href="{{ url_for('main.gallery') }}">
        <div class="">
          <i class="fas fa-th"></i>
          <!-- File view icon -->
        </div>
      </a>
      {% endif %}
    </div>
  </div>

  <!-- Breadcrumb Navigation -->
  <div class="breadcrumb">
    {% if folder_data %} {% for name, id in folder_data %} {% if not loop.first
    %}> {% endif %}
    <a href="{{ url_for('main.list_files', folder_id=id) }}">{{ name }}</a>
    {% endfor %} {% endif %}
  </div>

  <div class="table-container">
    <table class="file-list">
      <thead>
        <tr>
          <th>Name</th>
          <th>Date Added</th>
          <th>File Size</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="file-list-body">
        {% for item in folders %}
        <tr
          class="file-row no-select pointer"
          data-redirect-url="{{ url_for('main.list_files', folder_id=item.id) }}"
        >
          <td>
            <i class="fas fa-folder"></i>
            {{ item.name }}
          </td>
          <td
            class="upload-date"
            data-utc="{{ item.created_at.isoformat() }}"
          ></td>
          <td>—</td>
          <td class="actions-cell">
            <div class="actions">
              <a
                href="{{ url_for('main.download_folder', folder_id=item.id) }}"
              >
                <i class="fa fa-download" aria-hidden="true"></i>
              </a>
              <i
                class="fa fa-trash cursor"
                aria-hidden="true"
                data-url="{{ url_for('main.delete_folder', folder_id=item.id) }}"
              ></i>
            </div>
          </td>
        </tr>
        {% endfor %} {% for item in files %}
        <tr
          class="file-row no-select pointer"
          data-url="{{ url_for('main.get_file', file_id=item.id) }}"
        >
          <td><i class="fas fa-file"></i> {{ item.filename }}</td>
          <td
            class="upload-date"
            data-utc="{{ item.upload_date.isoformat() }}"
          ></td>
          <td class="file-size" data-size="{{ item.file_size }}"></td>
          <td class="actions-cell">
            <div class="actions">
              <a href="{{ url_for('main.download_file', file_id=item.id) }}">
                <i class="fa fa-download" aria-hidden="true"></i>
              </a>
              <i
                class="fa fa-trash cursor"
                aria-hidden="true"
                data-url="{{ url_for('main.delete_file', file_id=item.id) }}"
              ></i>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div id="loading-indicator" class="loading">
    <div class="spinner"></div>
    <span>Loading more files...</span>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".file-row").forEach(function (row) {
      if (row.getAttribute("data-url")) {
        row.addEventListener("dblclick", function () {
          const url = this.getAttribute("data-url");
          fetch(url, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => response.text())
            .then((html) => {
              const popupContainer = document.createElement("div");
              popupContainer.innerHTML = html;
              document.body.appendChild(popupContainer);

              const closeButton = popupContainer.querySelector(".media-close");
              if (closeButton) {
                closeButton.addEventListener("click", function () {
                  document.body.removeChild(popupContainer);
                });
              }
            })
            .catch((error) => {
              createNotificationPopup(
                "Error",
                "Failed to fetch file info.",
                "❌",
                5000
              );
              console.error("Error fetching file info:", error);
            });
        });
      } else if (row.getAttribute("data-redirect-url")) {
        row.addEventListener("dblclick", function () {
          const url = this.getAttribute("data-redirect-url");
          window.location.replace(url);
        });
      }
    });
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    let previousRow = null;

    // Function to highlight a row
    function highlightRow(row) {
      // Remove the class from the previously selected row
      if (previousRow) {
        previousRow.classList.remove("highlighted-row");
      }

      // Add the class to the clicked row
      row.classList.add("highlighted-row");

      // Update the previous row reference
      previousRow = row;
    }

    // Add click event listeners to each row
    document.querySelectorAll(".file-row").forEach(function (row) {
      row.addEventListener("click", function (event) {
        // Prevent event from propagating to the document click listener
        event.stopPropagation();
        highlightRow(this);
      });
    });

    // Add a click event listener to the document
    document.addEventListener("click", function () {
      if (previousRow) {
        previousRow.classList.remove("highlighted-row");
        previousRow = null;
      }
    });
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".fa-trash").forEach(function (icon) {
      icon.addEventListener("click", function () {
        const url = this.getAttribute("data-url");
        const row = this.closest("tr");

        if (confirm("Are you sure you want to delete this item?")) {
          fetch(url, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => {
              if (response.ok) {
                createNotificationPopup(
                  "Success",
                  "Successfully deleted item.",
                  "✅"
                );
                row.remove();
              } else {
                createNotificationPopup(
                  "Error",
                  "Failed to delete item.",
                  "❌",
                  5000
                );
                // alert("Failed to delete item.");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              createNotificationPopup(
                "Error",
                "Failed to delete item.",
                "❌",
                5000
              );
              // alert("Failed to delete item.");
            });
        }
      });
    });
  });
</script>
<script>
  function applyFormatting() {
    // Format dates and file sizes for existing elements
    document.querySelectorAll(".upload-date").forEach((el) => {
      const utcDateStr = el.getAttribute("data-utc");
      if (utcDateStr) {
        el.textContent = formatDate(utcDateStr);
      } else {
        el.textContent = "Invalid date";
      }
    });

    let fileList = document.querySelector(".file-list");

    fileList.querySelectorAll(".file-size").forEach((el) => {
      const sizeInBytes = parseInt(el.getAttribute("data-size"), 10);
      if (!isNaN(sizeInBytes)) {
        el.textContent = formatFileSize(sizeInBytes);
      } else {
        el.textContent = "Invalid size";
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    applyFormatting();
  });
</script>
{% endblock %}
